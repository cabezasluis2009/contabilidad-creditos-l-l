/**
 * Core Philosophy: This ruleset enforces a strict user-ownership model. All user-generated
 * content (categories, incomes, expenses, inventories, products) is completely private and can only
 * be accessed by the user who created it. There is no public or shared data.
 *
 * Data Structure: All data is segregated and nested within a user-specific data tree,
 * following the path `/users/{userId}/{collection}/{documentId}`. This structure is the
 * foundation of the security model, isolating each user's data from all others.
 *
 * Key Security Decisions:
 * - User Isolation: A user can only interact with documents located under their own UID
 *   (e.g., `/users/THEIR_OWN_UID/...`). Cross-user access is strictly forbidden.
 * - Disallowed User Listing: The top-level `/users` collection cannot be listed,
 *   preventing enumeration of all application users.
 * - Default Secure: Any operation not explicitly permitted is denied. There are no
 *   publicly writable collections.
 *
 * Denormalization for Authorization: To ensure fast and secure authorization checks, a `userId`
 * field is denormalized (copied) onto every document within a user's subcollections
 * (e.g., categories, incomes). Rules validate this field on write operations to maintain
 * data integrity and enforce ownership without needing costly `get()` calls to parent documents.
 *
 * Structural Segregation: Each data type (Category, Income, Expense, Inventory, Product) is stored
 * in its own dedicated subcollection under the user's document. This clean separation
 * simplifies rules and makes list operations secure and efficient.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the authenticated user's UID matches the provided userId.
     * This is the core function for enforcing data ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Returns true if the document being written to already exists.
     * Used to protect against updates or deletes on non-existent documents.
     */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Validates that a new user document has an `id` field that correctly
     * matches the user's auth UID. Enforces relational integrity on creation.
     */
    function isCreatingValidUserDoc(userId) {
      return request.resource.data.id == userId;
    }

    /**
     * Ensures the `id` field of a user document cannot be changed after creation.
     * This prevents re-assigning the user document to a different user.
     */
    function isUpdatingUserDocCorrectly() {
      return request.resource.data.id == resource.data.id;
    }

    /**
     * Validates that a new document in a user subcollection has a `userId` field
     * that correctly matches the user's auth UID. Enforces ownership on creation.
     */
    function isCreatingValidOwnedDoc(userId) {
      return request.resource.data.userId == userId;
    }

    /**
     * Ensures the `userId` field of a document cannot be changed after creation.
     * This prevents re-assigning ownership of the document.
     */
    function isUpdatingOwnedDocCorrectly() {
      return request.resource.data.userId == resource.data.userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Controls access to a user's own profile document.
     * @path /users/{userId}
     * @allow (create) An authenticated user can create their own user document.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc, data: { id: 'user_abc', ... }
     * @deny (create) An authenticated user cannot create a document for another user.
     *   auth: { uid: 'user_abc' }, path: /users/user_xyz, ...
     * @deny (list) No one can list all users in the application.
     *   auth: { uid: 'user_abc' }, path: /users
     * @principle Restricts access to a user's own data tree and prevents user enumeration.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && isCreatingValidUserDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingUserDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to a user's private categories.
     * @path /users/{userId}/categories/{categoryId}
     * @allow (create) A user can create a category within their own data tree.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/categories/cat_123, data: { userId: 'user_abc', ... }
     * @deny (get) A user cannot read categories belonging to another user.
     *   auth: { uid: 'user_abc' }, path: /users/user_xyz/categories/cat_456
     * @principle Enforces strict data ownership for all CRUD and list operations.
     */
    match /users/{userId}/categories/{categoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingValidOwnedDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingOwnedDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to a user's private income records.
     * @path /users/{userId}/incomes/{incomeId}
     * @allow (list) A user can list all of their own income records.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/incomes
     * @deny (update) A user cannot update income records for another user.
     *   auth: { uid: 'user_abc' }, path: /users/user_xyz/incomes/inc_456
     * @principle Enforces strict data ownership for all CRUD and list operations.
     */
    match /users/{userId}/incomes/{incomeId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingValidOwnedDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingOwnedDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to a user's private expense records.
     * @path /users/{userId}/expenses/{expenseId}
     * @allow (delete) A user can delete one of their own expense records.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/expenses/exp_123
     * @deny (create) A user cannot create an expense record with a mismatched userId in the body.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/expenses/exp_123, data: { userId: 'user_xyz', ... }
     * @principle Enforces strict data ownership and validates relational integrity on writes.
     */
    match /users/{userId}/expenses/{expenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingValidOwnedDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingOwnedDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }

    /**
     * @description Controls access to a user's private inventory items.
     * @path /users/{userId}/inventories/{inventoryId}
     * @allow (get) A user can get one of their own inventory items.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/inventories/inv_123
     * @deny (list) An unauthenticated user cannot list any inventory items.
     *   auth: null, path: /users/user_abc/inventories
     * @principle Enforces strict data ownership for all CRUD and list operations.
     */
    match /users/{userId}/inventories/{inventoryId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingValidOwnedDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingOwnedDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }
    
    /**
     * @description Controls access to a user's private products.
     * @path /users/{userId}/products/{productId}
     * @allow (list) A user can list all of their own products.
     *   auth: { uid: 'user_abc' }, path: /users/user_abc/products
     * @deny (get) A user cannot read products belonging to another user.
     *   auth: { uid: 'user_abc' }, path: /users/user_xyz/products/prod_456
     * @principle Enforces strict data ownership for all CRUD and list operations.
     */
    match /users/{userId}/products/{productId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && isCreatingValidOwnedDoc(userId);
      allow update: if isOwner(userId) && isExistingDoc() && isUpdatingOwnedDocCorrectly();
      allow delete: if isOwner(userId) && isExistingDoc();
    }
  }
}
